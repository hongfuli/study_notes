# 普通索引和唯一索引，应该怎么选择？

虽然本篇内容在讲索引选择，其实引出数据更新和读取过程中 change buffer 概念。

## 读取数据
这里有个『数据页』的概念，即 B+ 树的叶子结点数据块。当查询数据时，哪怕只需要一行数据，也是读取所在的整页数据加载到内存中。
所以普通索引和唯一索引对于查询数据基本没有什么性能影响，不非就在一个数据页中多对比一点数据，这对于 CPU 来说可忽略不计。

## 写入数据
前面说到数据页会缓存在内存中，当更新数据数据时，对于普通索引：

1. 如果数据页在内存中，则直接更新内存数据。
2. 如果数据页不在内存中，则写 change buffer。这样不用加载数据页到内存，有两个好处：减少磁盘随机读；减少系统 buffer pool。

而对于唯一索引更新数据不能使用 change buffer，因为需要判断数据的唯一性，所以相关数据页必须加载到内存中，数据页在内存中的话，就没有 change buffer 什么事了。

结论就是：如果使用唯一索引，读取数据基本没有区别，更新数据唯一索引因为需要加载数据页到内存，不能使用 change buff，所以性能会差一点。

## change buffer 使用场景
change buffer 用来缓存数据更新在内存，如果更新完数据马上查询数据，则会触发加载数据页到内存并 merge，这样适得其反。
所以 change buffer 适合写多读少场景。

## change buffer 与 redo log 关系
redo log 主要是节省随机写磁盘的 IO 消耗：如果没有 redo log，则每次修改数据需要在磁盘上定位到写入位置，这就是随机写。

change buffer 主要是节省随机读磁盘：如果没有 change buffer，则每次修改前需要加载相关数据页到内存，这会导致磁盘随机读。

我在这里有些疑问:

1. change buffer 会记录在 redo log，那应该没必要自己做持久啊？
1. 为什么不直接在 redo log 里记录这个更新操作而省掉 change buffer 呢？我想的原因是，这会导致在 merge 阶段时，如果从 redog log 中加载操作日志了，会导致磁盘扫描。

